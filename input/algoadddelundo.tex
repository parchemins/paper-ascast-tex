
\SetKwProg{Function}{func}{}{}

\small

\DontPrintSemicolon
\LinesNumbered

$O_p$, $W_p$ \tcp*[r]{set of neighbors and weights}
$V \leftarrow \varnothing$ \tcp*[r]{vector of versions}
$c \leftarrow 0$ \tcp*[r]{local counter}
$best \leftarrow \varnothing$ \tcp*[r]{best $\alpha$ so far}
%% $bests$ \tcp*[r]{last delivered $\alpha$ of $p$ and neighbors}

\BlankLine
\BlankLine

\Function{\textup{Add ( )} \tcp*[f]{$\alpha_{p, c}^{0, \varnothing} $}} {
  $c \leftarrow c + 1$ \;
  \textup{receiveAdd($p$, $p$, $c$, $0$, $\varnothing$)}
}

\Function{\textup{Del ( )} \tcp*[f]{$\delta_{p, c}$}} {
  $c \leftarrow c + 1$ \;
  \textup{receiveDel($p$, $p$, $c$)}
}

\BlankLine
\BlankLine

\Function{\textup{receiveAdd($q$, $s'$, $c'$, $d'$, $\pi'$)}
\tcp*[f]{\smash{$r_p(\alpha_{s', c'}^{d', \pi'})$}}  \textup{\texttt{from}} $q$} {
  \If {$p \not\in \pi'$ \label{line:notloopingA}} {
      \uIf {$c' \geq V[s']$ \label{line:detectA}} {
          $V[s'] \leftarrow c'$ \;
          \If {$best \leq_\alpha \langle s', c', d', \pi'\rangle$} {
              $best \leftarrow \langle s', c', d', \pi'\rangle$ \;
              \ForEach{$n \in O_p$}
                  {send$_n$($s'$, $c'$, $d' + W_{pq}$, $\pi' \cup p$)}
           }
      } \uElseIf {$q = best.\pi[|best.\pi| - 1] \wedge q \in O_p$ \label{line:detectB}} {
          \textup{receiveDel($q$, $best$)} \tcp*[r]{undo}
      }
      
   }
}

\Function{\textup{receiveDel($q$, $s'$, $c'$, $\pi'$)}
\tcp*[f]{\tiny \smash{$r_p (\delta_{s', c'})$ \textup{\texttt{or}} $r_p (\delta_{s', c'}^{\pi'})$}}} {
  \If {$p \not\in \pi'$ \label{line:notloopingB}} {
     $V[s'] \leftarrow \max(V[s'], c')$ \;
     \uIf {$\langle s', c', \pi' \rangle \overset{\alpha}{=} best $} {
         $best \leftarrow \varnothing$ \;
        \ForEach{$n \in O_p$} {
            \lIf{$\pi' = \varnothing$} {send$_q$($s'$, $c'$)}
            \lElse{send$_n$($s'$, $c'$, $\pi' \cup p$)}}
     } \uElseIf {$best \neq \varnothing \wedge q \in O_p$} {
         \textbf{let} $\langle s, c, d, \pi \rangle \leftarrow best$ \;
         \textup{send$_q$($s, c, d + W_{pq}, \pi \cup p$)} \tcp*[r]{\label{line:compete}compete}
     }
  }
}


